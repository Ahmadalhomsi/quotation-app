// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Para birimi enum'ı
enum Currency {
  TL
  USD
}



// Müşteri durumu tipi (artık enum değil, database'de saklanacak)

// Unified customer type system (replaces both status and labels)
model CustomerType {
  id          String   @id @default(cuid())
  name        String   @unique // Örn: "VIP Müşteri", "Yeni Potansiyel", "Sorunlu"
  color       String   @default("#6B7280") // Hex renk kodu
  description String?  // Açıklama
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0) // Sıralama
  
  // Type category to help organize (optional)
  category    String?  // Örn: "status", "priority", "source", "custom"
  
  customerTypes CustomerCustomerType[]
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("customer_types")
}

// Many-to-many relationship between customers and types
model CustomerCustomerType {
  id        String   @id @default(cuid())
  
  customerId String      @map("customer_id")
  customer   Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  typeId     String      @map("type_id")
  type       CustomerType @relation(fields: [typeId], references: [id], onDelete: Cascade)
  
  createdAt  DateTime @default(now()) @map("created_at")
  
  @@unique([customerId, typeId]) // Same customer can't have same type multiple times
  @@map("customer_customer_types")
}

// Teklif durumu enum'ı
enum QuotationStatus {
  DRAFT     // Taslak
  SENT      // Gönderildi
  ACCEPTED  // Kabul edildi
  REJECTED  // Reddedildi
  EXPIRED   // Süresi doldu
}

// Müşteri modeli
model Customer {
  id          String         @id @default(cuid())
  companyName String         @map("company_name") // Şirket adı
  contactName String         @map("contact_name") // İletişim kişisi
  email       String?        @unique
  phone       String?
  address     String?
  taxNumber   String?        @map("tax_number") // Vergi numarası
  taxOffice   String?        @map("tax_office") // Vergi dairesi
  
  // Marketing ve CRM alanları
  priority    Int                   @default(1) // Öncelik (1=Düşük, 2=Orta, 3=Yüksek)
  source      String?               // Kaynak (website, referans, reklam, vb.)
  notes       String?               // Marketing notları
  lastContact DateTime?             @map("last_contact") // Son iletişim tarihi
  nextContact DateTime?             @map("next_contact") // Sonraki iletişim tarihi
  
  quotations  Quotation[]
  activities  CustomerActivity[]    // Müşteri aktiviteleri
  customerTypes CustomerCustomerType[] // Müşteri tipleri (unified status and labels)
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("customers")
}

// Müşteri aktiviteleri modeli (pazarlama takibi için)
model CustomerActivity {
  id          String   @id @default(cuid())
  type        String   // Aktivite türü (arama, email, demo, ziyaret, vb.)
  description String?  // Aktivite açıklaması
  result      String?  // Aktivite sonucu
  nextAction  String?  @map("next_action") // Sonraki eylem
  
  customerId  String   @map("customer_id")
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  createdBy   String?  @map("created_by") // Aktiviteyi oluşturan kişi
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@map("customer_activities")
}

// Ürün modeli
model Product {
  id          String      @id @default(cuid())
  name        String      // Ürün adı
  description String?     // Açıklama
  price       Decimal     @db.Decimal(10, 2) // Satış fiyatı
  purchasePrice Decimal?  @db.Decimal(10, 2) @map("purchase_price") // Alış fiyatı (maliyet)
  currency    Currency    // Para birimi (TL/USD)
  sku         String?     @unique // Stok kodu
  photoUrl    String?     @map("photo_url") // Ürün fotoğrafı URL'i (MinIO)
  isActive    Boolean     @default(true) @map("is_active") // Aktif mi
  
  quotationItems QuotationItem[]
  
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("products")
}

// Teklif modeli
model Quotation {
  id              String          @id @default(cuid())
  quotationNumber String          @unique @map("quotation_number") // Teklif numarası
  title           String          // Teklif başlığı
  description     String?         // Açıklama
  status          QuotationStatus @default(DRAFT)
  validUntil      DateTime        @map("valid_until") // Geçerlilik tarihi
  
  customerId      String          @map("customer_id")
  customer        Customer        @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  items           QuotationItem[]
  
  // Toplam tutarlar (hesaplanmış)
  totalTL         Decimal?        @db.Decimal(10, 2) @map("total_tl")
  totalUSD        Decimal?        @db.Decimal(10, 2) @map("total_usd")
  exchangeRate    Decimal?        @db.Decimal(10, 4) @map("exchange_rate") // Kullanılan döviz kuru
  
  // KDV bilgileri
  kdvEnabled      Boolean?        @default(true) @map("kdv_enabled") // KDV dahil mi?
  kdvRate         Decimal?        @default(20) @db.Decimal(5, 2) @map("kdv_rate") // KDV oranı (%)
  
  // Notlar
  terms           String?         // Şartlar ve koşullar
  notes           String?         // Notlar
  
  // Call tracking status
  callStatus      String?         @default("takip et") @map("call_status") // "arandı", "1 daha ara", "takip et"
  
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  
  @@map("quotations")
}

// Teklif kalemi modeli
model QuotationItem {
  id          String    @id @default(cuid())
  quantity    Int       // Miktar
  unitPrice   Decimal   @db.Decimal(10, 2) @map("unit_price") // Birim fiyat
  totalPrice  Decimal   @db.Decimal(10, 2) @map("total_price") // Toplam fiyat
  currency    Currency  // Para birimi
  discount    Decimal?  @default(0) @db.Decimal(5, 2) @map("discount") // İskonto oranı (%)
  
  quotationId String    @map("quotation_id")
  quotation   Quotation @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  
  productId   String    @map("product_id")
  product     Product   @relation(fields: [productId], references: [id])
  
  // Snapshot of product details at the time of quotation
  productName String    @map("product_name") // Ürün adı (o anki)
  
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  @@map("quotation_items")
}

// Döviz kuru geçmişi (opsiyonel, cache için)
model ExchangeRate {
  id        String   @id @default(cuid())
  rate      Decimal  @db.Decimal(10, 4) // USD/TL kuru
  date      DateTime @unique @db.Date
  source    String   @default("api") // Kaynak
  
  createdAt DateTime @default(now()) @map("created_at")
  
  @@map("exchange_rates")
}
